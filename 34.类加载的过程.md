## 类加载的过程

+ 加载

  在加载阶段，虚拟机要完成一下3件事情：

  1. 通过一个类的全限定名来获取定义此类的二进制字节流

  2. 将这个字节流所代表的静态存储结构转化为方法区的运行时数据结构

  3. 在内存中生成一个代表这个类的java.lang.Class对象，作为方法区这个类的各种数据的访问入口

+ 验证

  验证是连接阶段的第一步，目的是为了确保Class文件的字节流中包含的信息符合当前虚拟机的要求，并且不会危害虚拟机自身的安全。

  + 文件格式验证

    第一阶段验证字节流是否符合Class文件格式的规范。这一阶段的验证可能包括下面这些验证点：

    + 是否以魔数0xCAFEBABE开头
    + 主次版本号是否在当前虚拟机的处理范围之内
    + 常量池中的长两种是否有不被支持的常量类型
    + 指向常量的各种索引值中是否有指向不存在的常量或不符合类型的常量
    + CONSTANT_Utf8_info型的常量中是否有不符合UTF8编码的数据
    + Class文件中各个部分及文件本身是否有被删除的或附加的其他信息
    + ......

  + 元数据验证

    第二阶段是对字节码描述的信息进行语义分析，以保证其描述的信息符合Java语言规范的要求，这个阶段可能包括的验证点如下：

    + 这个类是否有父类（除了java.lang.Object外，所有的类都应当有父类）
    + 这个类的父类是否继承了不允许继承的类（被final修饰的类）
    + 如果这个类不是抽象类，是否实现了其父类或接口中要求实现的所有方法
    + 类中的字段、方法是否与父类产生矛盾
    + ......

  + 字节码验证

    第三阶段验证是最复杂的一部分，目的是通过数据流和控制流分析，确定语义是合法的、符合逻辑的。在第二阶段堆元数据信息中的数据类型做完校验后，这个阶段将对类的方法体进行校验分析，保证被校验类的方法在运行时不会做出危害虚拟机安全的事件。

  + 符号引用验证

    最后一个阶段的校验发生在虚拟机将符号引用转化为直接引用的时候，这个转化动作将在连接的第三阶段-解析阶段发生。符号引用验证可以看做是堆类自身以外的信息进行匹配性校验，通常需要交验下列内容：

    + 符号引用中通过字符串描述的全限定名是否能找到对应的类
    + 在指定类中是否存在符合方法的字段描述符以及简单名称所描述的方法和字段
    + 符号引用中的类、字段】方法的访问性是否可以被当前类访问
    + ......

    符号引用验证的目的是确保解析动作能正常执行，如果无法通过符号引用验证，将会抛出一个java.lang.IncompatibleClassChangeError异常的子类，如java.lang.IllegalAccessError、java.lang.NoSuchFieldError、java.lang.NoSuchMethodError等。

+ 准备

+ 解析

+ 初始化